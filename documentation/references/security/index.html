<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="x-ua-compatible" content="ie=edge"> <title>Security | OPA</title> <meta name="description" content="OPA: An open source project to policy-enable your service."> <link type="text/css" rel="stylesheet" href="/assets/style.css"> </head> <body> <nav> <ul class="opa-nav-main--list"> <li class="opa-nav-main--home-item"> <a class="opa-nav-main--link" href="/">Open Policy Agent</a> </li> <li class="opa-nav-main--item"> <a class="opa-nav-main--link" href="/get-opa/">Get OPA</a> </li> <li class="opa-nav-main--item--selected"> Documentation </li> <li class="opa-nav-main--item"> <a class="opa-nav-main--link" href="/tutorials/working-with-the-opa-repl/">Tutorials</a> </li> <li class="opa-nav-main--item"> <a class="opa-nav-main--link" href="/community/">Community</a> </li> <li class="opa-nav-main--item"> <a class="opa-nav-main--link" href="https://blog.openpolicyagent.org">Blog</a> </li> </ul> </nav> <header class="opa-header"> <p class="opa-header--fork-me"><a href="https://github.com/open-policy-agent/opa"><img src="/assets/github-corner-right.svg" alt="Fork me on GitHub" width="80" height="80"></a></p> <div class="opa-content"> <div class="opa-header--abstract"> <nav class="opa-header--abstract--nav"> <ul class="opa-header--abstract--nav-list"> <li class="opa-header--abstract--nav-item"> <a class="opa-header--abstract--nav-link" href="/documentation/what-is-policy-enablement/">What is Policy Enablement?</a> </li> <li class="opa-header--abstract--nav-item"> <a class="opa-header--abstract--nav-link" href="/documentation/how-does-opa-work/">How Does OPA Work?</a> </li> <li class="opa-header--abstract--nav-item"> <a class="opa-header--abstract--nav-link" href="/documentation/how-do-i-write-policies/">How Do I Write Policies?</a> </li> <li class="opa-header--abstract--nav-item"> <a class="opa-header--abstract--nav-link" href="/documentation/references/language/">Language Reference</a> </li> <li class="opa-header--abstract--nav-item"> <a class="opa-header--abstract--nav-link" href="/documentation/references/rest/">REST API</a> </li> <li class="opa-header--abstract--nav-item"> <a class="opa-header--abstract--nav-link" href="/documentation/references/deployments/">Deployments</a> </li> <li class="opa-header--abstract--nav-item--selected"> Security </li> </ul> </nav> <h1>Security</h1> <p>This document provides guidelines for deploying OPA inside untrusted environments. You should read this document if you are deploying OPA as a service.</p> </div> </div> </header> <div class="opa-content"> <h2>API Security</h2> <p>Securing the API involves configuring OPA to use TLS, authentication, and authorization so that:</p> <ul> <li>Traffic between OPA and clients is encrypted.</li> <li>Clients verify the OPA API endpoint identity.</li> <li>OPA verifies client identities.</li> <li>Clients are only granted access to specific APIs or sections of <a href="/documentation/how-does-opa-work#the-data-document">The <code class="highlighter-rouge">data</code> Document</a>.</li> </ul> <h3>TLS &amp; HTTPS</h3> <p>HTTPS is configured by specifying TLS credentials via command line flags at startup:</p> <ul> <li><code class="highlighter-rouge">--tls-cert-file=&lt;path&gt;</code> specifies the path of the file containing the TLS certificate.</li> <li><code class="highlighter-rouge">--tls-private-key-file=&lt;path&gt;</code> specifies the path of the file containing the TLS private key.</li> </ul> <p>OPA will exit immediately with a non-zero status code if only one of these flags is specified.</p> <p>By default, OPA ignores insecure HTTP connections when TLS is enabled. To allow insecure HTTP connections in addition to HTTPS connections, provide another listening address with <code class="highlighter-rouge">--insecure-addr</code>.</p> <h4>1. Generate the TLS credentials for OPA (Example)</h4> <div class="language-bash highlighter-rouge"><pre class="highlight"><code>openssl genrsa -out private.key 2048
openssl req -new -x509 -sha256 -key private.key -out public.crt -days 1
</code></pre> </div> <blockquote class="opa-tip"> <p>We have generated a self-signed certificate for example purposes here. DO NOT rely on self-signed certificates outside of development without understanding the risks.</p> </blockquote> <h4>2. Start OPA with TLS enabled</h4> <div class="language-bash highlighter-rouge"><pre class="highlight"><code>opa run --server --log-level debug <span class="se">\</span>
    --tls-cert-file public.crt <span class="se">\</span>
    --tls-private-key-file private.key
</code></pre> </div> <h4>3. Try to access the API with HTTP</h4> <div class="language-bash highlighter-rouge"><pre class="highlight"><code>curl http://localhost:8181/v1/data
</code></pre> </div> <h4>4. Access the API with HTTPS</h4> <div class="language-bash highlighter-rouge"><pre class="highlight"><code>curl -k https://localhost:8181/v1/data
</code></pre> </div> <blockquote class="opa-tip"> <p>We have to use cURLâ€™s <code class="highlighter-rouge">-k/--insecure</code> flag because we are using a self-signed certificate.</p> </blockquote> <h3>Authentication &amp; Authorization</h3> <p>This section shows how to configure OPA to authenticate and authorize client requests. Client-side authentication of the OPA API endpoint should be handled with TLS.</p> <p>Authentication and authorization allow OPA to:</p> <ul> <li>Verify client identities.</li> <li>Control client access to APIs and data.</li> </ul> <p>Both are configured via command line flags:</p> <ul> <li><code class="highlighter-rouge">--authentication=&lt;scheme&gt;</code> specifies the authentication scheme to use.</li> <li><code class="highlighter-rouge">--authorization=&lt;scheme&gt;</code> specifies the authorization scheme to use.</li> </ul> <p>By default, OPA does not perform authentication or authorization and these flags default to <code class="highlighter-rouge">off</code>.</p> <p>For authentication, OPA supports:</p> <ul> <li><a href="/documentation/references/rest#bearer-tokens">Bearer tokens</a>: Bearer tokens are enabled by starting OPA with <code class="highlighter-rouge">--authentication=token</code>.</li> </ul> <p>For authorization, OPA relies on policy written in Rego. Authorization is enabled by starting OPA with <code class="highlighter-rouge">--authorization=basic</code>.</p> <p>When the <code class="highlighter-rouge">basic</code> authorization scheme is enabled, a minimal authorization policy must be provided on startup. The authorization policy must be structured as follows:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="c1"># The "system" namespace is reserved for internal use</span>
<span class="c1"># by OPA. Authorization policy must be defined under</span>
<span class="c1"># system.authz as follows:</span>
<span class="n">package</span> <span class="nb">system</span><span class="p">.</span><span class="nf">authz</span>

<span class="n">default</span> <span class="n">allow</span> <span class="o">=</span> <span class="kp">false</span>  <span class="c1"># Reject requests by default.</span>

<span class="n">allow</span> <span class="p">{</span>
  <span class="c1"># Logic to authorize request goes here.</span>
<span class="p">}</span>
</code></pre> </div> <p>When OPA receives a request, it executes a query against the document defined <code class="highlighter-rouge">data.system.authz.allow</code>. The implementation of the policy may span multiple packages however it is recommended that administrators keep the policy under the <code class="highlighter-rouge">system</code> namespace.</p> <p>If the document produced by the <code class="highlighter-rouge">allow</code> rule is <code class="highlighter-rouge">true</code>, the request is processed normally. If the document is undefined or <strong>not</strong> <code class="highlighter-rouge">true</code>, the request is rejected immediately.</p> <p>OPA provides the following input document when executing the authorization policy:</p> <div class="language-ruby opa-collapse--ignore highlighter-rouge"><pre class="highlight"><code><span class="p">{</span>
    <span class="s2">"input"</span><span class="p">:</span> <span class="p">{</span>
        <span class="c1"># Identity established by authentication scheme.</span>
        <span class="c1"># When Bearer tokens are used, the identity is</span>
        <span class="c1"># set to the Bearer token value.</span>
        <span class="s2">"identity"</span><span class="p">:</span> <span class="o">&lt;</span><span class="no">String</span><span class="o">&gt;</span><span class="p">,</span>

        <span class="c1"># One of {GET, POST, PUT, PATCH, DELETE}.</span>
        <span class="s2">"method"</span><span class="p">:</span> <span class="o">&lt;</span><span class="no">HTTP</span> <span class="no">Method</span><span class="o">&gt;</span><span class="p">,</span>

        <span class="c1"># URL path represented as an array.</span>
        <span class="c1"># For example: /v1/data/exempli-gratia</span>
        <span class="c1"># is represented as [v1, data, exampli-gratia]</span>
        <span class="s2">"path"</span><span class="p">:</span> <span class="o">&lt;</span><span class="no">HTTP</span> <span class="no">URL</span> <span class="no">Path</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre> </div> <p>At a minimum, the authorization policy should grant access to a special root identity:</p> <div class="language-ruby opa-collapse--ignore highlighter-rouge"><pre class="highlight"><code><span class="n">package</span> <span class="nb">system</span><span class="p">.</span><span class="nf">authz</span>

<span class="n">default</span> <span class="n">allow</span> <span class="o">=</span> <span class="kp">false</span>          <span class="c1"># Reject requests by default.</span>

<span class="n">allow</span> <span class="p">{</span>                        <span class="c1"># Allow request if...</span>
    <span class="s2">"secret"</span> <span class="o">=</span> <span class="n">input</span><span class="p">.</span><span class="nf">identity</span>  <span class="c1"># Identity is the secret root key.</span>
<span class="p">}</span>
</code></pre> </div> <p>When OPA is configured with this minimal authorization policy, requests without authentication are rejected:</p> <div class="language-http highlighter-rouge"><pre class="highlight"><code><span class="nf">GET</span> <span class="nn">/v1/policies</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</code></pre> </div> <p>Response:</p> <div class="language-http highlighter-rouge"><pre class="highlight"><code><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">401</span> <span class="ne">Unauthorized</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/json</span>
</code></pre> </div> <div class="language-json highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"code"</span><span class="p">:</span><span class="w"> </span><span class="s2">"unauthorized"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"request rejected by administrative policy"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre> </div> <p>However, if Bearer token authentication is enabled and the request includes the secret from above, the request is allowed:</p> <div class="language-http highlighter-rouge"><pre class="highlight"><code><span class="nf">GET</span> <span class="nn">/v1/policies</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Authorization</span><span class="p">:</span> <span class="s">Bearer secret</span>
</code></pre> </div> <p>Response:</p> <div class="language-http highlighter-rouge"><pre class="highlight"><code><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/json</span>
</code></pre> </div> <p>When Bearer tokens are used for authentication, the policy should at minimum validate the identity:</p> <div class="language-ruby opa-collapse--ignore highlighter-rouge"><pre class="highlight"><code><span class="n">package</span> <span class="nb">system</span><span class="p">.</span><span class="nf">authz</span>

<span class="c1"># Tokens may defined in policy or pushed into OPA as data.</span>
<span class="n">tokens</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"my-secret-token-foo"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"roles"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"admin"</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="s2">"my-secret-token-bar"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"roles"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"service-1"</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="s2">"my-secret-token-baz"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"roles"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"service-2"</span><span class="p">,</span> <span class="s2">"service-3"</span><span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">default</span> <span class="n">allow</span> <span class="o">=</span> <span class="kp">false</span>          <span class="c1"># Reject requests by default.</span>

<span class="n">allow</span> <span class="p">{</span>                        <span class="c1"># Allow request if...</span>
    <span class="n">input</span><span class="p">.</span><span class="nf">identity</span> <span class="o">=</span> <span class="s2">"secret"</span>  <span class="c1"># Identity is the secret root key.</span>
<span class="p">}</span>

<span class="n">allow</span> <span class="p">{</span>                        <span class="c1"># Allow request if...</span>
    <span class="n">tokens</span><span class="p">[</span><span class="n">input</span><span class="p">.</span><span class="nf">identity</span><span class="p">]</span>     <span class="c1"># Identity exists in "tokens".</span>
<span class="p">}</span>
</code></pre> </div> <p>To complete this example, the policy could further restrict tokens to specific documents:</p> <div class="language-ruby opa-collapse--ignore highlighter-rouge"><pre class="highlight"><code><span class="n">package</span> <span class="nb">system</span><span class="p">.</span><span class="nf">authz</span>

<span class="c1"># Rights may be defined in policy or pushed into OPA as data.</span>
<span class="n">rights</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"admin"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"path"</span><span class="p">:</span> <span class="s2">"*"</span>
    <span class="p">},</span>
    <span class="s2">"service-1"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"path"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"v1"</span><span class="p">,</span> <span class="s2">"data"</span><span class="p">,</span> <span class="s2">"exempli"</span><span class="p">,</span> <span class="s2">"gratia"</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="s2">"service-2"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"path"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"v1"</span><span class="p">,</span> <span class="s2">"data"</span><span class="p">,</span> <span class="s2">"par"</span><span class="p">,</span> <span class="s2">"example"</span><span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Tokens may be defined in policy or pushed into OPA as data.</span>
<span class="n">tokens</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"my-secret-token-foo"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"roles"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"admin"</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="s2">"my-secret-token-bar"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"roles"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"service-1"</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="s2">"my-secret-token-baz"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"roles"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"service-2"</span><span class="p">,</span> <span class="s2">"service-3"</span><span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">default</span> <span class="n">allow</span> <span class="o">=</span> <span class="kp">false</span>               <span class="c1"># Reject requests by default.</span>

<span class="n">allow</span> <span class="p">{</span>                             <span class="c1"># Allow request if...</span>
    <span class="n">identity_rights</span><span class="p">[</span><span class="n">right</span><span class="p">]</span>          <span class="c1"># Rights for identity exist, and...</span>
    <span class="n">right</span><span class="p">.</span><span class="nf">path</span> <span class="o">=</span> <span class="s2">"*"</span>                <span class="c1"># Right.path is '*'.</span>
<span class="p">}</span> <span class="p">{</span>                                 <span class="c1"># Or...</span>
    <span class="n">identity_rights</span><span class="p">[</span><span class="n">right</span><span class="p">]</span>          <span class="c1"># Rights for identity exist, and...</span>
    <span class="n">right</span><span class="p">.</span><span class="nf">path</span> <span class="o">=</span> <span class="n">input</span><span class="p">.</span><span class="nf">path</span>         <span class="c1"># Right.path matches input.path.</span>
<span class="p">}</span>

<span class="n">identity_rights</span><span class="p">[</span><span class="n">right</span><span class="p">]</span> <span class="p">{</span>            <span class="c1"># Right is in the identity_rights set if...</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="n">input</span><span class="p">.</span><span class="nf">identity</span><span class="p">]</span>  <span class="c1"># Token exists for identity, and...</span>
    <span class="n">role</span> <span class="o">=</span> <span class="n">token</span><span class="p">.</span><span class="nf">roles</span><span class="p">[</span><span class="n">_</span><span class="p">]</span>           <span class="c1"># Token has a role, and...</span>
    <span class="n">right</span> <span class="o">=</span> <span class="n">rights</span><span class="p">[</span><span class="n">role</span><span class="p">]</span>            <span class="c1"># Role has rights defined.</span>
<span class="p">}</span>
</code></pre> </div> </div> <footer class="opa-footer"> <p class="opa-footer--text"> <a class="opa-footer--github--link" href="https://github.com/open-policy-agent/opa"><img src="/assets/icon-github.svg" class="opa-footer--github--icon" width="16" height="16" alt="icon-github.svg">open-policy-agent/opa</a> <a href="https://travis-ci.org/open-policy-agent/opa"><img class="opa-footer--github--ci" width="90" height="20" src="https://travis-ci.org/open-policy-agent/opa.svg?branch=master" alt="Build Status"></a> </p> <p class="opa-footer--text"> Join the discussion on <a class="opa-footer--link" href="http://slack.openpolicyagent.org">Slack</a> or <a class="opa-footer--link" href="https://groups.google.com/forum/?hl=en#!forum/open-policy-agent">Google Groups</a>. Report a bug or request a feature using <a class="opa-footer--link" href="https://github.com/open-policy-agent/opa/issues">GitHub Issues</a>. </p> <p class="opa-footer--text"> Â© 2016 Open Policy Agent contributors. Licensed under the <a class="opa-footer--link" href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a>. For information about contributing, see <a class="opa-footer--link" href="https://github.com/open-policy-agent/opa/blob/master/CONTRIBUTING.md">CONTRIBUTING.md</a>. </p> </footer> <script>var OPA_COLLAPSE_CONFIG={classNames:"highlight",baseClassName:"opa-collapse",collapsedClassName:"opa-collapse--collapsed",ignoreClassName:"opa-collapse--ignore",maxHeight:320,targetClassName:"opa-collapse--target"};</script> <script>!function(e,t,a,n,c,s,o){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,s=t.createElement(a),o=t.getElementsByTagName(a)[0],s.async=1,s.src=n,o.parentNode.insertBefore(s,o)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-84550302-1","auto"),ga("send","pageview");</script> <script type="text/javascript" src="/assets/dom.js"></script> <script type="text/javascript" src="/assets/collapse.js"></script> </body> </html>