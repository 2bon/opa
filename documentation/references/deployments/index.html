<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="x-ua-compatible" content="ie=edge"> <title>Deployments | OPA</title> <meta name="description" content="OPA: An open source project to policy-enable your service."> <link type="text/css" rel="stylesheet" href="/assets/style.css"> </head> <body> <nav> <ul class="opa-nav-main--list"> <li class="opa-nav-main--home-item"> <a class="opa-nav-main--link" href="/">Open Policy Agent</a> </li> <li class="opa-nav-main--item"> <a class="opa-nav-main--link" href="/get-opa/">Get OPA</a> </li> <li class="opa-nav-main--item--selected"> Documentation </li> <li class="opa-nav-main--item"> <a class="opa-nav-main--link" href="/examples/docker-authorization/">Examples</a> </li> <li class="opa-nav-main--item"> <a class="opa-nav-main--link" href="/community/">Community</a> </li> <li class="opa-nav-main--item"> <a class="opa-nav-main--link" href="https://blog.openpolicyagent.org">Blog</a> </li> </ul> </nav> <header class="opa-header"> <p class="opa-header--fork-me"><a href="https://github.com/open-policy-agent/opa"><img src="/assets/github-corner-right.svg" alt="Fork me on GitHub" width="80" height="80"></a></p> <div class="opa-content"> <div class="opa-header--abstract"> <nav class="opa-header--abstract--nav"> <ul class="opa-header--abstract--nav-list"> <li class="opa-header--abstract--nav-item"> <a class="opa-header--abstract--nav-link" href="/documentation/what-is-policy-enablement/">What is Policy Enablement?</a> </li> <li class="opa-header--abstract--nav-item"> <a class="opa-header--abstract--nav-link" href="/documentation/how-does-opa-work/">How Does OPA Work?</a> </li> <li class="opa-header--abstract--nav-item"> <a class="opa-header--abstract--nav-link" href="/documentation/how-do-i-write-policies/">How Do I Write Policies?</a> </li> <li class="opa-header--abstract--nav-item"> <a class="opa-header--abstract--nav-link" href="/documentation/references/language/">Language Reference</a> </li> <li class="opa-header--abstract--nav-item"> <a class="opa-header--abstract--nav-link" href="/documentation/references/rest/">REST API</a> </li> <li class="opa-header--abstract--nav-item--selected"> Deployments </li> <li class="opa-header--abstract--nav-item"> <a class="opa-header--abstract--nav-link" href="/documentation/references/security/">Security</a> </li> </ul> </nav> <h1>Deployments</h1> <p>This document helps you get OPA up and running in different deployment environments. You should read this document if you are planning to deploy OPA.</p> </div> </div> </header> <div class="opa-content"> <h2>Docker</h2> <p>Docker makes OPA easy to deploy in different types of environments.</p> <p>This section explains how to use the official OPA Docker images. If this is your first time deploying OPA and you plan to use one of the Docker images, we recommend you review this section to familiarize yourself with the basics.</p> <p>OPA releases are available as images on Docker Hub.</p> <ul class="opa-deployments--docker-hub-list"> <li><a href="https://hub.docker.com/r/openpolicyagent/opa/" class="opa-deployments--docker-hub-list--link">openpolicyagent/opa:0.4.7</a></li> </ul> <h3>Running</h3> <p>If you start OPA outside of Docker without any arguments, it prints a list of available commands. By default, the official OPA Docker image executes the <code class="highlighter-rouge">run</code> command which starts an instance of OPA as an interactive shell. This is nice for development, however, for deployments, we want to run OPA as a server.</p> <p>The <code class="highlighter-rouge">run</code> command accepts a <code class="highlighter-rouge">--server</code> (or <code class="highlighter-rouge">-s</code>) flag that starts OPA as a server. See <code class="highlighter-rouge">--help</code> for more information on other arguments. The most important command line arguments for OPA’s server mode are:</p> <ul> <li><code class="highlighter-rouge">--addr</code> to set the listening address (default: <code class="highlighter-rouge">0.0.0.0:8181</code>).</li> <li><code class="highlighter-rouge">--log-level</code> (or <code class="highlighter-rouge">-l</code>) to set the log level (default: <code class="highlighter-rouge">"info"</code>).</li> <li><code class="highlighter-rouge">--log-format</code> to set the log format (default: <code class="highlighter-rouge">"text"</code>).</li> </ul> <p>By default, OPA listens for normal HTTP connections on <code class="highlighter-rouge">0.0.0.0:8181</code>. To make OPA listen for HTTPS connections, see <a href="../security/">Security</a>.</p> <p>We can run OPA as a server using Docker:</p> <div class="language-bash highlighter-rouge"><pre class="highlight"><code>docker run -p 8181:8181 openpolicyagent/opa <span class="se">\</span>
    run --server --log-level debug
</code></pre> </div> <p>Test that OPA is available:</p> <div class="highlighter-rouge"><pre class="highlight"><code>curl -i localhost:8181/
</code></pre> </div> <h4>Logging</h4> <p>OPA logs to stderr. The verbosity can be increased with <code class="highlighter-rouge">--log-level debug</code> to provide details on API requests and responses:</p> <div class="highlighter-rouge"><pre class="highlight"><code>time="2017-03-12T03:03:23Z" level=info msg="First line of log stream." addr=":8181"
time="2017-03-12T03:03:30Z" level=debug msg="Received request." client_addr="172.17.0.1:60952" req_body= req_id=1 req_method=GET req_params=map[] req_path="/v1/data"
time="2017-03-12T03:03:30Z" level=debug msg="Sent response." client_addr="172.17.0.1:60952" req_id=1 req_method=GET req_path="/v1/data" resp_bytes=13 resp_duration=0.402793 resp_status=200
</code></pre> </div> <blockquote class="opa-tip"> <p>Request logs contain the entire message body. This is useful for debugging purposes but can be expensive in practice.</p> </blockquote> <p>The default log format is text-based and intended for development. For production, enable JSON formatting with <code class="highlighter-rouge">--log-format json</code>:</p> <div class="highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="nt">"client_addr"</span><span class="p">:</span><span class="s2">"[::1]:64427"</span><span class="p">,</span><span class="nt">"level"</span><span class="p">:</span><span class="s2">"debug"</span><span class="p">,</span><span class="nt">"msg"</span><span class="p">:</span><span class="s2">"Received request."</span><span class="p">,</span><span class="nt">"req_body"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="nt">"req_id"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="nt">"req_method"</span><span class="p">:</span><span class="s2">"GET"</span><span class="p">,</span><span class="nt">"req_params"</span><span class="p">:{},</span><span class="nt">"req_path"</span><span class="p">:</span><span class="s2">"/v1/data"</span><span class="p">,</span><span class="nt">"time"</span><span class="p">:</span><span class="s2">"2017-03-11T18:22:18-08:00"</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nt">"client_addr"</span><span class="p">:</span><span class="s2">"[::1]:64427"</span><span class="p">,</span><span class="nt">"level"</span><span class="p">:</span><span class="s2">"debug"</span><span class="p">,</span><span class="nt">"msg"</span><span class="p">:</span><span class="s2">"Sent response."</span><span class="p">,</span><span class="nt">"req_id"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="nt">"req_method"</span><span class="p">:</span><span class="s2">"GET"</span><span class="p">,</span><span class="nt">"req_path"</span><span class="p">:</span><span class="s2">"/v1/data"</span><span class="p">,</span><span class="nt">"resp_bytes"</span><span class="p">:</span><span class="mi">13</span><span class="p">,</span><span class="nt">"resp_duration"</span><span class="p">:</span><span class="mf">0.392554</span><span class="p">,</span><span class="nt">"resp_status"</span><span class="p">:</span><span class="mi">200</span><span class="p">,</span><span class="nt">"time"</span><span class="p">:</span><span class="s2">"2017-03-11T18:22:18-08:00"</span><span class="p">}</span><span class="w">
</span></code></pre> </div> <h4>Volume Mounts</h4> <p>By default, OPA does not include any data or policies.</p> <p>The simplest way to load data and policies into OPA is to provide them via the file system as command line arguments. When running inside Docker, you can provide files via volume mounts.</p> <div class="language-bash highlighter-rouge"><pre class="highlight"><code>docker run -v <span class="nv">$PWD</span>/example:/example openpolicyagent/opa <span class="se">\</span>
    run -e <span class="s1">'data.example.greeting'</span> <span class="se">\</span>
    /example
</code></pre> </div> <p><strong>$PWD/example/data.json</strong>:</p> <div class="language-json highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nt">"hostOS"</span><span class="p">:</span><span class="w"> </span><span class="s2">"$(uname)"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre> </div> <p><strong>$PWD/example/policy.rego</strong>:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">package</span> <span class="n">example</span>

<span class="n">greeting</span> <span class="o">=</span> <span class="n">msg</span> <span class="p">{</span>
    <span class="n">concat</span><span class="p">(</span><span class="s2">""</span><span class="p">,</span> <span class="p">[</span><span class="s2">"Hello "</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="nf">example</span><span class="p">.</span><span class="nf">hostOS</span><span class="p">,</span> <span class="s2">"!"</span><span class="p">],</span> <span class="n">msg</span><span class="p">)</span>
<span class="p">}</span>
</code></pre> </div> <h4>More Information</h4> <p>For more information on OPA’s command line, see <code class="highlighter-rouge">--help</code>:</p> <div class="highlighter-rouge"><pre class="highlight"><code>docker run openpolicyagent/opa run --help
</code></pre> </div> <h3>Tagging</h3> <p>The Docker Hub repository contains tags for every release of OPA. For more information on each release see the <a href="https://github.com/open-policy-agent/opa/releases">GitHub Releases</a> page.</p> <p>The “latest” tag refers to the most recent release. The latest tag is convenient if you want to quickly try out OPA however for production deployments, we recommend using an explicit version tag.</p> <p>Development builds are also available on Docker Hub. For each version the <code class="highlighter-rouge"><span class="p">{</span><span class="err">version</span><span class="p">}</span><span class="err">-dev</span></code> tag refers the most recent development build for that version.</p> <p>The version information is contained in the OPA executable itself. You can check the version with the following command:</p> <div class="language-bash highlighter-rouge"><pre class="highlight"><code>docker run openpolicyagent/opa version
</code></pre> </div> <h2>Kubernetes</h2> <h3>Kicking the Tires</h3> <p>This section shows how to quickly deploy OPA on top of Kubernetes to try it out.</p> <blockquote class="opa-tip"> <p>These steps assume Kubernetes is deployed with <a href="https://github.com/kubernetes/minikube">minikube</a>. If you are using a different Kubernetes provider, the steps should be similar. You may need to use a different Service configuration at the end.</p> </blockquote> <p>First, create a ConfigMap containing a test policy. The policy will inspect “pod” objects provided as input. If the pod is missing a “customer” label or the pod includes containers that refer to images outside the acmecorp registry, “allow” will be false.</p> <p>In this case, the policy file does not contain sensitive information so it’s fine to store as a ConfigMap. If the file contained sensitive information, then we recommend you store it as a Secret.</p> <div class="language-ruby opa-collapse--ignore highlighter-rouge"><pre class="highlight"><code><span class="n">package</span> <span class="n">example</span>

<span class="n">import</span> <span class="n">input</span><span class="p">.</span><span class="nf">pod</span>

<span class="n">default</span> <span class="n">allow</span> <span class="o">=</span> <span class="kp">true</span>

<span class="n">allow</span> <span class="o">=</span> <span class="kp">false</span> <span class="p">{</span>
    <span class="n">not</span> <span class="n">pod</span><span class="p">.</span><span class="nf">metadata</span><span class="p">.</span><span class="nf">labels</span><span class="p">.</span><span class="nf">customer</span>
<span class="p">}</span>

<span class="n">allow</span> <span class="o">=</span> <span class="kp">false</span> <span class="p">{</span>
    <span class="n">container</span> <span class="o">=</span> <span class="n">pod</span><span class="p">.</span><span class="nf">spec</span><span class="p">.</span><span class="nf">containers</span><span class="p">[</span><span class="n">_</span><span class="p">]</span>
    <span class="n">not</span> <span class="n">re_match</span><span class="p">(</span><span class="s2">"^registry.acmecorp.com/.+$"</span><span class="p">,</span> <span class="n">container</span><span class="p">.</span><span class="nf">image</span><span class="p">)</span>
<span class="p">}</span>
</code></pre> </div> <div class="language-bash highlighter-rouge"><pre class="highlight"><code>kubectl create configmap example-policy <span class="se">\</span>
    --from-file example.rego
</code></pre> </div> <p>Next, create a ReplicationController to deploy OPA. The ConfigMap containing the policy is volume mounted into the container. This allows OPA to load the policy from the file system.</p> <div class="language-yaml opa-collapse--ignore highlighter-rouge"><pre class="highlight"><code><span class="s">kind</span><span class="pi">:</span> <span class="s">ReplicationController</span>
<span class="s">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="s">metadata</span><span class="pi">:</span>
  <span class="s">name</span><span class="pi">:</span> <span class="s">opa</span>
<span class="s">spec</span><span class="pi">:</span>
  <span class="s">replicas</span><span class="pi">:</span> <span class="s">1</span>
  <span class="s">selector</span><span class="pi">:</span>
    <span class="s">app</span><span class="pi">:</span> <span class="s">opa</span>
  <span class="s">template</span><span class="pi">:</span>
    <span class="s">metadata</span><span class="pi">:</span>
      <span class="s">labels</span><span class="pi">:</span>
        <span class="s">app</span><span class="pi">:</span> <span class="s">opa</span>
    <span class="s">spec</span><span class="pi">:</span>
      <span class="s">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">name</span><span class="pi">:</span> <span class="s">example-policy</span>
        <span class="s">configMap</span><span class="pi">:</span>
          <span class="s">name</span><span class="pi">:</span> <span class="s">example-policy</span>
      <span class="s">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">name</span><span class="pi">:</span> <span class="s">opa</span>
        <span class="s">image</span><span class="pi">:</span> <span class="s">openpolicyagent/opa</span>
        <span class="s">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">name</span><span class="pi">:</span> <span class="s">http</span>
          <span class="s">containerPort</span><span class="pi">:</span> <span class="s">8181</span>
        <span class="s">args</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s2">"</span><span class="s">run"</span>
        <span class="pi">-</span> <span class="s2">"</span><span class="s">--server"</span>
        <span class="pi">-</span> <span class="s2">"</span><span class="s">/policies/example.rego"</span>
        <span class="s">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">readOnly</span><span class="pi">:</span> <span class="s">true</span>
          <span class="s">mountPath</span><span class="pi">:</span> <span class="s">/policies</span>
          <span class="s">name</span><span class="pi">:</span> <span class="s">example-policy</span>
</code></pre> </div> <div class="language-bash highlighter-rouge"><pre class="highlight"><code>kubectl create -f rc_opa.yaml
</code></pre> </div> <p>At this point OPA is up and running. Create a Service to expose the OPA API so that you can query it:</p> <div class="language-yaml opa-collapse--ignore highlighter-rouge"><pre class="highlight"><code><span class="s">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="s">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="s">metadata</span><span class="pi">:</span>
  <span class="s">name</span><span class="pi">:</span> <span class="s">opa</span>
  <span class="s">labels</span><span class="pi">:</span>
    <span class="s">app</span><span class="pi">:</span> <span class="s">opa</span>
<span class="s">spec</span><span class="pi">:</span>
  <span class="s">type</span><span class="pi">:</span> <span class="s">NodePort</span>
  <span class="s">selector</span><span class="pi">:</span>
    <span class="s">app</span><span class="pi">:</span> <span class="s">opa</span>
  <span class="s">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">name</span><span class="pi">:</span> <span class="s">http</span>
      <span class="s">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
      <span class="s">port</span><span class="pi">:</span> <span class="s">8181</span>
      <span class="s">targetPort</span><span class="pi">:</span> <span class="s">8181</span>
</code></pre> </div> <div class="language-bash highlighter-rouge"><pre class="highlight"><code>kubectl create -f svc_opa.yaml
</code></pre> </div> <p>Get the URL of OPA using <code class="highlighter-rouge">minikube</code>:</p> <div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="nv">OPA_URL</span><span class="o">=</span><span class="k">$(</span>minikube service opa --url<span class="k">)</span>
</code></pre> </div> <p>Exercise the OPA API. Note that the container below references an image outside our hypothetical repository:</p> <div class="language-json opa-collapse--ignore highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nt">"input"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nt">"kind"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Pod"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"apiVersion"</span><span class="p">:</span><span class="w"> </span><span class="s2">"v1"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"metadata"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"opa"</span><span class="p">,</span><span class="w">
            </span><span class="nt">"labels"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nt">"customer"</span><span class="p">:</span><span class="w"> </span><span class="s2">"example.org"</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nt">"spec"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nt">"containers"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="p">{</span><span class="w">
                    </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"opa"</span><span class="p">,</span><span class="w">
                    </span><span class="nt">"image"</span><span class="p">:</span><span class="w"> </span><span class="s2">"openpolicyagent/opa"</span><span class="w">
                </span><span class="p">}</span><span class="w">
            </span><span class="p">]</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre> </div> <div class="language-bash highlighter-rouge"><pre class="highlight"><code>curl <span class="nv">$OPA_URL</span>/v1/data -d @example_pod.json
</code></pre> </div> </div> <footer class="opa-footer"> <p class="opa-footer--text"> <a class="opa-footer--github--link" href="https://github.com/open-policy-agent/opa"><img src="/assets/icon-github.svg" class="opa-footer--github--icon" width="16" height="16" alt="icon-github.svg">open-policy-agent/opa</a> <a href="https://travis-ci.org/open-policy-agent/opa"><img class="opa-footer--github--ci" width="90" height="20" src="https://travis-ci.org/open-policy-agent/opa.svg?branch=master" alt="Build Status"></a> </p> <p class="opa-footer--text"> Join the discussion on <a class="opa-footer--link" href="http://slack.openpolicyagent.org">Slack</a> or <a class="opa-footer--link" href="https://groups.google.com/forum/?hl=en#!forum/open-policy-agent">Google Groups</a>. Report a bug or request a feature using <a class="opa-footer--link" href="https://github.com/open-policy-agent/opa/issues">GitHub Issues</a>. </p> <p class="opa-footer--text"> © 2016 Open Policy Agent contributors. Licensed under the <a class="opa-footer--link" href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a>. For information about contributing, see <a class="opa-footer--link" href="https://github.com/open-policy-agent/opa/blob/master/CONTRIBUTING.md">CONTRIBUTING.md</a>. </p> </footer> <script>var OPA_COLLAPSE_CONFIG={classNames:"highlight",baseClassName:"opa-collapse",collapsedClassName:"opa-collapse--collapsed",ignoreClassName:"opa-collapse--ignore",maxHeight:320,targetClassName:"opa-collapse--target"};</script> <script>!function(e,t,a,n,c,s,o){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,s=t.createElement(a),o=t.getElementsByTagName(a)[0],s.async=1,s.src=n,o.parentNode.insertBefore(s,o)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-84550302-1","auto"),ga("send","pageview");</script> <script type="text/javascript" src="/assets/dom.js"></script> <script type="text/javascript" src="/assets/collapse.js"></script> </body> </html>