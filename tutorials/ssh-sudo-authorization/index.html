<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="x-ua-compatible" content="ie=edge"> <title>SSH and sudo Authorization | OPA</title> <meta name="description" content="OPA: An open source project to policy-enable your service."> <link type="text/css" rel="stylesheet" href="/assets/style.css"> </head> <body> <nav> <ul class="opa-nav-main--list"> <li class="opa-nav-main--home-item"> <a class="opa-nav-main--link" href="/">Open Policy Agent</a> </li> <li class="opa-nav-main--item"> <a class="opa-nav-main--link" href="/get-opa/">Get OPA</a> </li> <li class="opa-nav-main--item"> <a class="opa-nav-main--link" href="/documentation/what-is-policy-enablement/">Documentation</a> </li> <li class="opa-nav-main--item--selected"> Tutorials </li> <li class="opa-nav-main--item"> <a class="opa-nav-main--link" href="/community/">Community</a> </li> <li class="opa-nav-main--item"> <a class="opa-nav-main--link" href="https://blog.openpolicyagent.org">Blog</a> </li> </ul> </nav> <header class="opa-header"> <p class="opa-header--fork-me"><a href="https://github.com/open-policy-agent/opa"><img src="/assets/github-corner-right.svg" alt="Fork me on GitHub" width="80" height="80"></a></p> <div class="opa-content"> <div class="opa-header--abstract"> <nav class="opa-header--abstract--nav"> <ul class="opa-header--abstract--nav-list"> <li class="opa-header--abstract--nav-item"> <a class="opa-header--abstract--nav-link" href="/tutorials/working-with-the-opa-repl/">Working with the OPA REPL</a> </li> <li class="opa-header--abstract--nav-item"> <a class="opa-header--abstract--nav-link" href="/tutorials/docker-authorization/">Docker Authorization</a> </li> <li class="opa-header--abstract--nav-item"> <a class="opa-header--abstract--nav-link" href="/tutorials/http-api-authorization/">HTTP API Authorization</a> </li> <li class="opa-header--abstract--nav-item--selected"> SSH and sudo Authorization </li> </ul> </nav> <h1>SSH and sudo Authorization</h1> <p>Host-level access controls are an important part of every organization’s security strategy. Using <a href="http://tldp.org/HOWTO/User-Authentication-HOWTO/x115.html">Linux-PAM</a> and OPA we can extend policy-based access control to SSH and sudo.</p> </div> </div> </header> <div class="opa-content"> <h2>Goals</h2> <p>This tutorial shows how you can use OPA and Linux-PAM to enforce fine-grained, host-level access controls over SSH and sudo.</p> <p>Linux-PAM can be configured to delegate authorization decisions to plugins (shared libraries). In this case, we have created an OPA-based plugin that can be configured to authorize SSH and sudo access. The OPA-based Linux-PAM plugin used in this tutorial can be found at <a href="https://github.com/open-policy-agent/contrib">open-policy-agent/contrib</a>.</p> <p>For this tutorial, our desired policy is:</p> <ul> <li>Admins can SSH into any host and run sudo commands.</li> <li>Normal users can SSH into hosts that they have <em>contributed</em> to.</li> <li>Normal users cannot run sudo commands.</li> </ul> <p>Furthermore, we’ll assume we have the following set of users and hosts:</p> <ul> <li><code class="highlighter-rouge">frontend-dev</code> is a developer who contributes to the app running on the <code class="highlighter-rouge">frontend</code> host.</li> <li><code class="highlighter-rouge">backend-dev</code> is a developer who contributes to the app running on the <code class="highlighter-rouge">backend</code> host.</li> <li><code class="highlighter-rouge">ops</code> is an administrator for the organization.</li> </ul> <p>Authentication (verifying user identity) is outside the scope of OPA’s responsibility so this tutorial relies on identities being statically defined. In real-world scenarios authentication can be delegated to SSH itself (authorized_keys) or other identity management systems.</p> <p>Let’s get started.</p> <h2>Prerequisites</h2> <p>This tutorial requires <a href="https://docs.docker.com/compose/install/">Docker Compose</a> to run dummy SSH hosts along with OPA. The dummy SSH hosts are just containers running sshd inside.</p> <h2>Steps</h2> <h3>1. Bootstrap the tutorial environment using Docker Compose.</h3> <p>First, create a docker-compose.yml file that runs OPA and the containers that represent our backend and frontend hosts.</p> <div class="language-shell opa-collapse--ignore highlighter-rouge"><pre class="highlight"><code>cat &gt; docker-compose.yml <span class="sh">&lt;&lt;EOF
version: '2'
services:
  opa:
    image: openpolicyagent/opa:0.4.9
    ports:
      - 8181:8181
    command:
      - "run"
      - "--server"
      - "--log-level=debug"
  frontend:
    image: openpolicyagent/demo-pam
    ports:
      - "2222:22"
    volumes:
      - ./frontend_host_id.json:/etc/host_identity.json
  backend:
    image: openpolicyagent/demo-pam
    ports:
      - "2223:22"
    volumes:
      - ./backend_host_id.json:/etc/host_identity.json
EOF
</span></code></pre> </div> <p>The docker-compose.yml file requires two other local files: <code class="highlighter-rouge">frontend_host_id.json</code> and <code class="highlighter-rouge">backend_host_id.json</code>. These files are mounted into the containers representing our hosts. The content of the file provides <em>context</em> that the PAM module provides as input when executing queries against OPA.</p> <p>Create the extra files required by docker-compose.yml:</p> <div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="nb">echo</span> <span class="s1">'{"host_id": "frontend"}'</span> &gt; frontend_host_id.json
<span class="nb">echo</span> <span class="s1">'{"host_id": "backend"}'</span> &gt; backend_host_id.json
</code></pre> </div> <blockquote class="opa-tip"> <p>In real-world scenarios, these files could contain arbitrary infomration that we want to expose to the policy.</p> </blockquote> <p>Finally, run <code class="highlighter-rouge">docker-compose</code> to pull and run the containers.</p> <div class="language-shell highlighter-rouge"><pre class="highlight"><code>docker-compose -f docker-compose.yml up
</code></pre> </div> <h3>2. Load policies and data into OPA.</h3> <p>In another terminal, load the policies and data into OPA that will control access to the hosts.</p> <p>First, create the policy that will control SSH access to hosts.</p> <div class="language-shell opa-collapse--ignore highlighter-rouge"><pre class="highlight"><code>cat &gt;ssh_authz.rego <span class="sh">&lt;&lt;EOF
package ssh.authz

# By default, users are not authorized.
default allow = false

# Allow access to any user that has the "admin" role.
allow {
    data.roles["admin"][_] = input.user
}

# Allow access to any user who contributed to the code running on the host.
allow {
    data.hosts[input.host_identity.host_id].contributors[_] = input.user
}

# If the user is not authorized, then include an error message in the response.
errors["request denied by administrative policy"] {
    not allow
}
EOF
</span></code></pre> </div> <p>Push this policy into OPA:</p> <div class="language-shell highlighter-rouge"><pre class="highlight"><code>curl -X PUT --data-binary @ssh_authz.rego <span class="se">\</span>
  localhost:8181/v1/policies/ssh_authz
</code></pre> </div> <p>Next, create the policy that will control sudo access on the hosts.</p> <div class="language-shell opa-collapse--ignore highlighter-rouge"><pre class="highlight"><code>cat &gt;sudo_authz.rego <span class="sh">&lt;&lt;EOF
package sudo.authz

# By default, users are not authorized.
default allow = false

# Allow sudo access to any user that has the "admin" role.
allow {
    data.roles["admin"][_] = input.user
}

# If the user is not authorized, include this error message in the response.
errors["user does not have role admin"] {
    not allow
}
EOF
</span></code></pre> </div> <p>Push this policy into OPA:</p> <div class="language-shell highlighter-rouge"><pre class="highlight"><code>curl -X PUT --data-binary @sudo_authz.rego <span class="se">\</span>
  localhost:8181/v1/policies/sudo_authz
</code></pre> </div> <p>Finally, load the data that represents our roles and contributors into OPA.</p> <div class="language-shell highlighter-rouge"><pre class="highlight"><code>curl -X PUT localhost:8181/v1/data/roles -d <span class="se">\</span>
<span class="s1">'{
    "admin": ["ops"]
}'</span>
</code></pre> </div> <div class="language-shell highlighter-rouge"><pre class="highlight"><code>curl -X PUT localhost:8181/v1/data/hosts -d <span class="se">\</span>
<span class="s1">'{
  "frontend": {
    "contributors": [
      "frontend-dev"
    ]
  },
  "backend": {
    "contributors": [
      "backend-dev"
    ]
  }
}'</span>
</code></pre> </div> <h3>3. Prepare SSH key to login to hosts.</h3> <p>This tutorial uses a special Docker image named <code class="highlighter-rouge">openpolicyagent/demo-pam</code> to simulate an SSH server. This image contains:</p> <ol> <li>Pre-created Linux accounts for our users.</li> <li>Pre-populated authorized_keys files for our users.</li> </ol> <p>You must have the correct private key to SSH into the containers. Run the following command to write the private key to a local file:</p> <div class="language-shell opa-collapse--ignore highlighter-rouge"><pre class="highlight"><code>cat &gt;ssh_authz.key <span class="sh">&lt;&lt;EOF
-----BEGIN RSA PRIVATE KEY-----
MIIEowIBAAKCAQEA5o4tuzLqNq8ZASzVuDxlzop/Odn2JKn48i8q7Yr2pl9gBUcx
cfpBIAoCh+v9GY3dBPSyyx6XSYyA+7ajSm8hQn167jX0WLItcz7r5vRYB3+aGfeo
sys8OXaloG+aaTPvK711HS7FxQLX9EHBzCHgVKW0438HT7vuPFmB5KRKRG5b6s9K
CUx4lig/J+gFYF3bxviBoL95y3PEY174pzqXVrnEpjCQqNCcytOSBYjEsu8Tq/72
KDL8EcUl4Q++lfN9ksPa5SsxlvQB+z/cJ1fEwMsdSN9RrxBeNtG8wLpk15S+Guki
UNqCYb60IOKm0nFSag5O0zhxePX0zyN+ar7NzwIDAQABAoIBAQCZ9Y/sVk+5PKxB
8KK3aP3DMxFKnJaWXTr03zKXdhjHeSEx5RzLtAYRUx3ljl1x1x4k1RMgOMlmQAFS
FeBtMFDRieGxeS42nKVlNDtr+vdd6oQJmyx4mQKajPSFcoF2h0vLtbSjTDydFw0G
+3Ji0qxvWki1Mnq7cA/jFRJ8kIlXr+XLUMrmM6aeOtQKGMZa9Tu0Jfd+2eaiajfm
3UdN6j5dHp5svtQHfrE1u9P7r9Tk+RE7jfUYLUPgCsl6OoReWyS9o583APSlDxxm
SsksDGSetCh96MugaxAN3+hI9wzr6nnZs2CK3Vff2/Nm2szh2PimNwl/ik/i0uKt
fCyxKijBAoGBAP0frr/RZh0Mt1EgUmGXdbuHlj7J5jmQuqEvARr3JISNYySkEA+V
IcHJbH6q9dnMjT+f0xXR2b9V8RC9ucd5OIan4T9MHltanPaBWBPRUHxExOOhqPbW
7rrLODH2vAkgGbHI6HFPyU/K7x2HavJ3XEVtx/FgvMKy/kT64HJndup3AoGBAOks
2KvG/QyOjo/kpW5SR7cudQdPM3E/L/Cuc6MUep0q1UJHWuDVDa8zlfSigEoITE/7
/AvqbBKP/O1O7T423ncEqvw3mHTFMpryJ1XU+mMF+cg024+NqZpKHfyjw8gOepHg
Wa9mZNSLar8J4hkI2ZrIkQ3I2NuZANmjvZ4UgjVpAoGAfAurwtsmtLPHnp09YhAs
pTNEIQ8moS1ZGKaFXyagocj8Pjecm1ZVTbedUNINW6gPzI9Rjc7ibA787VxdD/FL
D0p0a2WtNs3IQFGQzV11mQDGkFtoB1e7dJUku++TpNEzZlnz95vHJzBnUExNz/dI
o8myA4uJ1cyMKVfc6JPlxe8CgYB8QMyZBOmVhmXLodDR8ACNSbFNGtRT1ZMLUzsF
vQT1uXx43CM+SeoH4ZpYCTwJt1BLEwElrF64qYfjQTrE+2Ii1Bb1Xf7cwrSLwtxZ
LavblrSbDiet4JRvRm2iUfYjJiwEjiPchtjWNhDFClQ0ePXUOGqriMqegnLkhw+l
LFKSeQKBgDs/Vs5AXmj4VAdupEpUS+dJJ4y6wi8lPQtMwNfY/1/DNsoTNibA9u66
cLtyaoaL64UV8TsEPqdbt0Kbj1bqeOyheN0qiCNA5pufvj219a/i9qZW3zHJkwDc
ed4qCYnDpcfRhi+PyFrjFdtw072BdndRlosukmiBSvVguJJYEoTP
-----END RSA PRIVATE KEY-----
EOF
</span></code></pre> </div> <p>Set the file permissions on the private key.</p> <div class="language-shell highlighter-rouge"><pre class="highlight"><code>chmod 600 ssh_authz.key
</code></pre> </div> <h3>4. SSH and sudo as a user with the <code class="highlighter-rouge">admin</code> role.</h3> <p>First, let’s try to access the hosts as the <code class="highlighter-rouge">ops</code> user. Recall, the <code class="highlighter-rouge">ops</code> user has been granted the <code class="highlighter-rouge">admin</code> role (via the <code class="highlighter-rouge">PUT /data/roles</code> request above) and users with the <code class="highlighter-rouge">admin</code> role can login to any host and perform sudo commands.</p> <p>Login to the <code class="highlighter-rouge">frontend</code> host (which has SSH listening on port 2222) and run a command with sudo as the <code class="highlighter-rouge">ops</code> user.</p> <div class="language-shell highlighter-rouge"><pre class="highlight"><code>ssh -p 2222 ops@localhost <span class="se">\</span>
  -i ssh_authz.key -o <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no
sudo ls /
<span class="nb">exit</span>
</code></pre> </div> <h3>5. SSH as a user without the <code class="highlighter-rouge">admin</code> role.</h3> <p>Let’s try a user without the admin role. Recall, that a non-admin user can SSH into any host that they have <em>contributed to</em>.</p> <p>The <code class="highlighter-rouge">frontend-dev</code> user contributed code to the <code class="highlighter-rouge">frontend</code> host so they should be able to login.</p> <div class="language-shell highlighter-rouge"><pre class="highlight"><code>ssh -p 2222 frontend-dev@localhost <span class="se">\</span>
  -i ssh_authz.key -o <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no
</code></pre> </div> <p>However, since <code class="highlighter-rouge">frontend-dev</code> is not an admin, they cannot run sudo commands.</p> <div class="language-shell highlighter-rouge"><pre class="highlight"><code>sudo ls /
<span class="nb">exit</span>
</code></pre> </div> <p>Furthermore, since <code class="highlighter-rouge">frontend-dev</code> did not contribute to the code running on the <code class="highlighter-rouge">backend</code> host (which has SSH listening on port 2223), they should not be able to login.</p> <div class="language-shell highlighter-rouge"><pre class="highlight"><code>ssh -p 2223 frontend-dev@localhost <span class="se">\</span>
  -i ssh_authz.key -o <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no
</code></pre> </div> <h3>6. Elevate a user’s rights through policy.</h3> <p>Suppose a user needs to be temporarily granted extra privileges. E.g., the user may need to debug an issue on a specific production host. In this case, we can add an another policy to temporarily allow this.</p> <p>Let’s allow the <code class="highlighter-rouge">frontend-dev</code> user to run sudo commands on the <code class="highlighter-rouge">frontend</code> host.</p> <div class="language-shell highlighter-rouge"><pre class="highlight"><code>cat &gt;sudo_authz_special.rego <span class="sh">&lt;&lt;EOF
package sudo.authz

allow {
  input.host_identity.host_id = "frontend"
  input.user = "frontend-dev"
}
EOF
</span></code></pre> </div> <p>Load this policy into OPA.</p> <div class="language-shell highlighter-rouge"><pre class="highlight"><code>curl -X PUT --data-binary @sudo_authz_special.rego <span class="se">\</span>
  localhost:8181/v1/policies/sudo_authz_special
</code></pre> </div> <p>Confirm that the user <code class="highlighter-rouge">frontend-dev</code> can login to the <code class="highlighter-rouge">frontend</code> host and run sudo commands.</p> <div class="language-shell highlighter-rouge"><pre class="highlight"><code>ssh -p 2222 frontend-dev@localhost <span class="se">\</span>
  -i ssh_authz.key -o <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no
sudo ls /
<span class="nb">exit</span>
</code></pre> </div> <p>Lastly, remove the policy from OPA and confirm the user’s original rights are restored.</p> <div class="language-shell highlighter-rouge"><pre class="highlight"><code>curl -i -X DELETE localhost:8181/v1/policies/sudo_authz_special
</code></pre> </div> <div class="language-shell highlighter-rouge"><pre class="highlight"><code>ssh -p 2222 frontend-dev@localhost <span class="se">\</span>
  -i ssh_authz.key -o <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no
sudo ls /
<span class="nb">exit</span>
</code></pre> </div> <h2>Wrap Up</h2> <p>Congratulations for finishing the tutorial!</p> <p>You learned a number of things about SSH with OPA:</p> <ul> <li>OPA gives you fine-grained policy control over SSH and sudo on any host where you’ve installed OPA and its PAM module.</li> <li>You write allow/deny policies to control who has access to what.</li> <li>You can import external data into OPA and write policies that depend on. that data.</li> </ul> <p>The code for this tutorial can be found in the <a href="https://github.com/open-policy-agent/contrib">open-policy-agent/contrib</a> repository.</p> </div> <footer class="opa-footer"> <p class="opa-footer--text"> <a class="opa-footer--github--link" href="https://github.com/open-policy-agent/opa"><img src="/assets/icon-github.svg" class="opa-footer--github--icon" width="16" height="16" alt="icon-github.svg">open-policy-agent/opa</a> <a href="https://travis-ci.org/open-policy-agent/opa"><img class="opa-footer--github--ci" width="90" height="20" src="https://travis-ci.org/open-policy-agent/opa.svg?branch=master" alt="Build Status"></a> </p> <p class="opa-footer--text"> Join the discussion on <a class="opa-footer--link" href="http://slack.openpolicyagent.org">Slack</a> or <a class="opa-footer--link" href="https://groups.google.com/forum/?hl=en#!forum/open-policy-agent">Google Groups</a>. Report a bug or request a feature using <a class="opa-footer--link" href="https://github.com/open-policy-agent/opa/issues">GitHub Issues</a>. </p> <p class="opa-footer--text"> © 2016 Open Policy Agent contributors. Licensed under the <a class="opa-footer--link" href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a>. For information about contributing, see <a class="opa-footer--link" href="https://github.com/open-policy-agent/opa/blob/master/CONTRIBUTING.md">CONTRIBUTING.md</a>. </p> </footer> <script>var OPA_COLLAPSE_CONFIG={classNames:"highlight",baseClassName:"opa-collapse",collapsedClassName:"opa-collapse--collapsed",ignoreClassName:"opa-collapse--ignore",maxHeight:320,targetClassName:"opa-collapse--target"};</script> <script>!function(e,t,a,n,c,s,o){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,s=t.createElement(a),o=t.getElementsByTagName(a)[0],s.async=1,s.src=n,o.parentNode.insertBefore(s,o)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-84550302-1","auto"),ga("send","pageview");</script> <script type="text/javascript" src="/assets/dom.js"></script> <script type="text/javascript" src="/assets/collapse.js"></script> </body> </html>